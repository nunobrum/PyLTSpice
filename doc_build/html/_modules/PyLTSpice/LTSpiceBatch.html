
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyLTSpice.LTSpiceBatch &#8212; PyLTSpice 2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PyLTSpice.LTSpiceBatch</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding=utf-8</span>

<span class="c1"># -------------------------------------------------------------------------------</span>
<span class="c1"># Name:        LTSpiceBatch.py</span>
<span class="c1"># Purpose:     Tool used to launch LTSpice simulation in batch mode. Netlsts can</span>
<span class="c1">#              be updated by user instructions</span>
<span class="c1">#</span>
<span class="c1"># Author:      Nuno Brum (nuno.brum@gmail.com)</span>
<span class="c1">#</span>
<span class="c1"># Created:     23-12-2016</span>
<span class="c1"># Licence:     lGPL v3</span>
<span class="c1"># -------------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Allows to launch LTSpice simulations from a Python Script, thus allowing to overcome the 3 dimensions STEP limitation on</span>
<span class="sd">LTSpice, update resistor values, or component models.</span>

<span class="sd">In the code snipped below will simulate a circuit with two different diode models, setting the simulation</span>
<span class="sd">temperature to 80 degrees and updates the values of R1 and R2 to 3.3k. ::</span>

<span class="sd">    LTC = SimCommander(&quot;my_circuit.asc&quot;)</span>
<span class="sd">    LTC.set_parameters(temp=80)  # Sets the simulation temperature to be 80 degrees</span>
<span class="sd">    LTC.set_component_value(&#39;R2&#39;, &#39;3.3k&#39;)  #  Updates the resistor R2 value to be 3.3k</span>
<span class="sd">    for dmodel in (&quot;BAT54&quot;, &quot;BAT46WJ&quot;):</span>
<span class="sd">        LTC.set_element_model(&quot;D1&quot;, model)  # Sets the Diode D1 model</span>
<span class="sd">        for res_value in sweep(2.2, 2,4, 0.2):  # Steps from 2.2 to 2.4 with 0.2 increments</span>
<span class="sd">            LTC.set_component_value(&#39;R1&#39;, res_value)  #  Updates the resistor R1 value to be 3.3k</span>
<span class="sd">            LTC.run()</span>

<span class="sd">    LTC.wait_completion()  # Waits for the LTSpice simulations to complete</span>

<span class="sd">    print(&quot;Total Simulations: {}&quot;.format(LTC.runno))</span>
<span class="sd">    print(&quot;Successful Simulations: {}&quot;.format(LTC.okSim))</span>
<span class="sd">    print(&quot;Failed Simulations: {}&quot;.format(LTC.failSim))</span>

<span class="sd">The first line will create an python class instance that represents the LTSpice file or netlist that is to be</span>
<span class="sd">simulated. This object implements methods that are used to manipulate the spice netlist. For example, the method</span>
<span class="sd">set_parameters() will set or update existing parameters defined in the netlist. The method set_component_value() is</span>
<span class="sd">used to update existing component values or models.</span>

<span class="sd">---------------</span>
<span class="sd">Multiprocessing</span>
<span class="sd">---------------</span>

<span class="sd">For making better use of today&#39;s computer capabilities, the SimCommander spawns several LTSpice instances</span>
<span class="sd">each executing in parallel a simulation.</span>
<span class="sd">By default the number of parallel simulations is 4, however the user can override this in two ways. Either</span>
<span class="sd">using the class constructor argument ``parallel_sims`` or by forcing the allocation of more processes in the</span>
<span class="sd">run() call by setting ``wait_resource=False``. ::</span>

<span class="sd">    LTC.run(wait_resource=False)</span>

<span class="sd">The recommended way is to set the parameter ``parallel_sims`` in the class constructor. ::</span>

<span class="sd">    LTC=SimCommander(&quot;my_circuit.asc&quot;, parallel_sims=8)</span>

<span class="sd">The user then can launch a simulation with the updates done to the netlist by calling the run() method. Since the</span>
<span class="sd">processes are not executed right aways, but rather just scheduled for simulation, the wait_completion() function is</span>
<span class="sd">needed if the user wants to execute code only after the completion of all scheduled simulations.</span>

<span class="sd">The usage of wait_completion() is optional. Just note that the script will only end when all the scheduled tasks are</span>
<span class="sd">executed.</span>

<span class="sd">---------</span>
<span class="sd">Callbacks</span>
<span class="sd">---------</span>

<span class="sd">As seen above, the `wait_completion()` can be used to wait for all the simulations to be finished. However, this is</span>
<span class="sd">not efficient on a multiprocessor point of view. Ideally, the post-processing should be also handled while other</span>
<span class="sd">simulations are still running. For this purpose, the user can use a function call backs.</span>

<span class="sd">The callback function is called when the simulation has finished direclty by the thread that has handling the</span>
<span class="sd">simulation. A function callback receives two arguments.</span>
<span class="sd">The RAW file and the LOG file names. Below is an example of a callback function::</span>

<span class="sd">    def processing_data(raw_filename, log_filename):</span>
<span class="sd">        &#39;&#39;&#39;This is a call back function that just prints the filenames&#39;&#39;&#39;</span>
<span class="sd">        print(&quot;Simulation Raw file is %s. The log is %s&quot; % (raw_filename, log_filename)</span>
<span class="sd">        # Other code below either using LTSteps.py or LTSpice_RawRead.py</span>
<span class="sd">        log_info = LTSpiceLogReader(log_filename)</span>
<span class="sd">        log_info.read_measures()</span>
<span class="sd">        rise, measures = log_info.dataset[&quot;rise_time&quot;]</span>

<span class="sd">The callback function is optional. if there no callback function is given then thread is terminated just after the</span>
<span class="sd">simulation is finished.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Nuno Canto Brum &lt;nuno.brum@gmail.com&gt;&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2020, Fribourg Switzerland&quot;</span>

<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">PyLTSpice.SpiceEditor</span> <span class="kn">import</span> <span class="n">SpiceEditor</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SimCommander&#39;</span><span class="p">,</span> <span class="s1">&#39;cmdline_switches&#39;</span><span class="p">,</span> <span class="s1">&#39;LTspice_exe&#39;</span><span class="p">)</span>

<span class="n">END_LINE_TERM</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;LTSpiceBatch.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span><span class="p">:</span>
    <span class="n">LTspice_exe</span> <span class="o">=</span> <span class="s1">&#39;wine C:</span><span class="se">\\\\</span><span class="s1">Program</span><span class="se">\\</span><span class="s1"> Files</span><span class="se">\\\\</span><span class="s1">LTC</span><span class="se">\\\\</span><span class="s1">LTspiceXVII</span><span class="se">\\\\</span><span class="s1">XVIIx64.exe&#39;</span>
    <span class="n">LTspice_arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;-Run&#39;</span><span class="p">]}</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
    <span class="n">LTspice_exe</span> <span class="o">=</span> <span class="s1">&#39;/Applications/LTspice.app/Contents/MacOS/LTspice&#39;</span>
    <span class="n">LTspice_arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-b&#39;</span><span class="p">]}</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Windows</span>
    <span class="n">LTspice_exe</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;C:\Program Files\LTC\LTspiceXVII\XVIIx64.exe&quot;</span><span class="p">]</span>
    <span class="n">LTspice_arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;netlist&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-netlist&#39;</span><span class="p">],</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;-Run&#39;</span><span class="p">]}</span>

<span class="c1"># Legacy</span>
<span class="n">LTspiceIV_exe</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;C:\Program Files (x86)\LTC\LTspiceIV\scad3.exe&quot;</span><span class="p">]</span>

<span class="n">cmdline_switches</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
    <span class="n">clock_function</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">process_time</span>

    <span class="k">def</span> <span class="nf">run_function</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">clock_function</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span>

    <span class="k">def</span> <span class="nf">run_function</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RunTask</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is an internal Class and should not be used directly by the User.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_no</span><span class="p">,</span> <span class="n">netlis_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>  <span class="c1"># Thanks to Daniel Phili for implemnting this</span>
        
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;sim</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">run_no</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_no</span> <span class="o">=</span> <span class="n">run_no</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netlist_file</span> <span class="o">=</span> <span class="n">netlis_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Signals an error by default</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Setting up</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sim</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_no</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># Running the Simulation</span>
        <span class="n">cmd_run</span> <span class="o">=</span> <span class="n">LTspice_exe</span> <span class="o">+</span> <span class="n">LTspice_arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">netlist_file</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmdline_switches</span>

        <span class="c1"># run the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">clock_function</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(),</span> <span class="s2">&quot;: Starting simulation </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_no</span><span class="p">)</span>

        <span class="c1"># start execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retcode</span> <span class="o">=</span> <span class="n">run_function</span><span class="p">(</span><span class="n">cmd_run</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># print simulation time</span>
        <span class="n">sim_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">clock_function</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span>

        <span class="c1"># Cleanup everything</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># simulation succesfull</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;: Simulation Successful. Time elapsed </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sim_time</span><span class="p">,</span> <span class="n">END_LINE_TERM</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span>
                <span class="n">netlist_radic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netlist_file</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.net&#39;</span><span class="p">)</span>
                <span class="n">raw_file</span> <span class="o">=</span> <span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.raw&#39;</span>
                <span class="n">log_file</span> <span class="o">=</span> <span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raw_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_file</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling the callback function&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Simulation Raw file or Log file were not found&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Callback&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># simulation failed</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;: Simulation Failed. Time elapsed </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sim_time</span><span class="p">,</span> <span class="n">END_LINE_TERM</span><span class="p">))</span>
            <span class="n">netlist_radic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netlist_file</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.net&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">,</span> <span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.fail&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="SimCommander"><a class="viewcode-back" href="../../LTSpiceBatch.html#PyLTSpice.LTSpiceBatch.SimCommander">[docs]</a><span class="k">class</span> <span class="nc">SimCommander</span><span class="p">(</span><span class="n">SpiceEditor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The SimCommander class implements all the methods required for launching batches of LTSpice simulations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parallel_sims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class Constructor. It serves to start batches of simulations.</span>
<span class="sd">        See Class documentation for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">circuit_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">circuit_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_radic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_switches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_sims</span> <span class="o">=</span> <span class="n">parallel_sims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># master_log_filename = self.circuit_radic + &#39;.masterlog&#39; TODO: create the JSON or YAML file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;SimCommander&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="c1"># TODO redirect this logger to a file.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runno</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of total runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failSim</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of failed simulations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">okSim</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of succesfull completed simulations</span>
        <span class="c1"># self.failParam = []  # collects for later user investigation of failed parameter sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netlist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Netlist needs to be created in the __init__ for LINT purposes</span>

        <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.asc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">netlist_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_radic</span> <span class="o">+</span> <span class="s1">&#39;.net&#39;</span>
            <span class="c1"># prepare instructions, two stages used to enable edits on the netlist w/o open GUI</span>
            <span class="c1"># see: https://www.mikrocontroller.net/topic/480647?goto=5965300#5965300</span>
            <span class="k">assert</span> <span class="s1">&#39;netlist&#39;</span> <span class="ow">in</span> <span class="n">LTspice_arg</span><span class="p">,</span> <span class="s2">&quot;In this platform LTSpice doesn&#39;t have netlist generation capabilities &quot;</span>
            <span class="n">cmd_netlist</span> <span class="o">=</span> <span class="n">LTspice_exe</span> <span class="o">+</span> <span class="n">LTspice_arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;netlist&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">circuit_file</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating Netlist&quot;</span><span class="p">)</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">run_function</span><span class="p">(</span><span class="n">cmd_netlist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The Netlist was successfully created&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_netlist</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>   <span class="c1"># Supposedly it is a net or similar net file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">netlist_file</span> <span class="o">=</span> <span class="n">circuit_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_netlist</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">netlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to create Netlist&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class Destructor : Closes Everything&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for all spawned threads to finish.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_completion</span><span class="p">()</span>  <span class="c1"># TODO: Kill all pending simulations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exiting SimCommander&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="SimCommander.setLTspiceRunCommand"><a class="viewcode-back" href="../../LTSpiceBatch.html#PyLTSpice.LTSpiceBatch.SimCommander.setLTspiceRunCommand">[docs]</a>    <span class="k">def</span> <span class="nf">setLTspiceRunCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually setting the LTSpice run command</span>

<span class="sd">        :param path: String containing the command to be invoked to run LTSpice</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">LTspice_exe</span>
        <span class="n">LTspice_exe</span> <span class="o">=</span> <span class="n">run_command</span></div>


<div class="viewcode-block" id="SimCommander.add_LTspiceRunCmdLineSwitches"><a class="viewcode-back" href="../../LTSpiceBatch.html#PyLTSpice.LTSpiceBatch.SimCommander.add_LTspiceRunCmdLineSwitches">[docs]</a>    <span class="k">def</span> <span class="nf">add_LTspiceRunCmdLineSwitches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to add an extra command line argument such as -I&lt;path&gt; to add symbol search path or -FastAccess</span>
<span class="sd">        to convert the raw file into Fast Access.</span>
<span class="sd">        The arguments is a list of strings as is defined in the LTSpice command line documentation.</span>

<span class="sd">        :param args: list of strings</span>
<span class="sd">            A list of command line switches such as &quot;-ascii&quot; for generating a raw file in text format or &quot;-alt&quot; for</span>
<span class="sd">            setting the solver to alternate. See Command Line Switches information on LTSpice help file.</span>
<span class="sd">        :type args: list[str]</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">cmdline_switches</span>
        <span class="n">cmdline_switches</span> <span class="o">=</span> <span class="n">args</span></div>

<div class="viewcode-block" id="SimCommander.run"><a class="viewcode-back" href="../../LTSpiceBatch.html#PyLTSpice.LTSpiceBatch.SimCommander.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wait_resource</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a simulation run with the conditions set by the user.</span>
<span class="sd">        Conditions are set by the set_parameter, set_component_value or add_instruction functions.</span>

<span class="sd">        :param run_filename:</span>
<span class="sd">            The name of the netlist can be optionally overridden if the user wants to have a better control of how the</span>
<span class="sd">            simulations files are generated.</span>
<span class="sd">        :type run_filename: str</span>
<span class="sd">        :param wait_resource:</span>
<span class="sd">            Setting this parameter to False, will force the simulation to start immediately, irrespective of the number</span>
<span class="sd">            of simulations already active.</span>
<span class="sd">            By default the SimCommander class uses only four processors. This number can then be overridden by setting</span>
<span class="sd">            the parameter ´parallel_sims´ to a different number.</span>
<span class="sd">            If there are more than ´parallel_sims´ simulations being done, the new one will be placed on hold till one</span>
<span class="sd">            of the other simulations are finished.</span>
<span class="sd">        :type wait_resource: bool</span>
<span class="sd">        :param callback:</span>
<span class="sd">            The user can optionally give a callback function for when the simulation finishes, so that a processing can</span>
<span class="sd">            be immediately done.</span>
<span class="sd">        :type: callback: function(raw_file, log_file)</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># decide sim required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update number of simulation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runno</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Using internal simulation number in case a run_id is not supplied</span>

            <span class="c1"># Write the new settings</span>
            <span class="k">if</span> <span class="n">run_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">run_netlist_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%i</span><span class="s2">.net&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit_radic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_netlist_file</span> <span class="o">=</span> <span class="n">run_filename</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_netlist</span><span class="p">(</span><span class="n">run_netlist_file</span><span class="p">)</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updated_stats</span><span class="p">()</span>  <span class="c1"># purge ended tasks</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">wait_resource</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_sims</span><span class="p">):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">RunTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">,</span> <span class="n">run_netlist_file</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span>
                                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Give slack for the thread to start</span>
                    <span class="k">break</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Give Time for other simulations to end</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runno</span>  <span class="c1"># Just returns the simulation number</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no simulation required</span>
            <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;skipping simulation &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">))</span></div>

<div class="viewcode-block" id="SimCommander.updated_stats"><a class="viewcode-back" href="../../LTSpiceBatch.html#PyLTSpice.LTSpiceBatch.SimCommander.updated_stats">[docs]</a>    <span class="k">def</span> <span class="nf">updated_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function updates the OK/Fail statistics and releases finished RunTask objects from memory.</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">okSim</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># simulation failed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failSim</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="SimCommander.wait_completion"><a class="viewcode-back" href="../../LTSpiceBatch.html#PyLTSpice.LTSpiceBatch.SimCommander.wait_completion">[docs]</a>    <span class="k">def</span> <span class="nf">wait_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will wait for the execution of all scheduled simulations to complete.</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_stats</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updated_stats</span><span class="p">()</span></div></div>


<span class="k">class</span> <span class="nc">LTCommander</span><span class="p">(</span><span class="n">SimCommander</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *(Deprecated)*</span>

<span class="sd">    Class for launching batch LTSpice simulations. Please use the new SimCommander class instead of LTCommander which</span>
<span class="sd">    supports multi-processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Deprecated Class. Please use the new SimCommander class instead of LTCommander</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;For more information consult. https://www.nunobrum.com/pyspicer.html&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="n">SimCommander</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">write_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mlog</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit_radic</span> <span class="o">+</span> <span class="s1">&#39;.masterlog&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">END_LINE_TERM</span><span class="p">):</span>
            <span class="n">mlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="n">END_LINE_TERM</span><span class="p">)</span>
        <span class="n">mlog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a simulation run with the conditions set by the user. (See also set_parameter, set_component_value,</span>
<span class="sd">        add_instruction)</span>
<span class="sd">        :param run_id: The run_id parameter can be used to override the naming protocol of the log files.</span>
<span class="sd">        :type run_id: int</span>
<span class="sd">        :returns: (raw filename, log filename) if simulation is successful else (None, log file name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update number of simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runno</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Using internal simulation number in case a run_id is not supplied</span>

        <span class="c1"># decide sim required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">netlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Write the new settings</span>
            <span class="n">run_netlist_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%i</span><span class="s2">.net&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit_radic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_netlist</span><span class="p">(</span><span class="n">run_netlist_file</span><span class="p">)</span>
            <span class="n">cmd_run</span> <span class="o">=</span> <span class="n">LTspice_exe</span> <span class="o">+</span> <span class="n">LTspice_arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">run_netlist_file</span><span class="p">]</span>

            <span class="c1"># run the simulation</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">clock_function</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(),</span> <span class="s2">&quot;: Starting simulation </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">)</span>

            <span class="c1"># start execution</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">run_function</span><span class="p">(</span><span class="n">cmd_run</span><span class="p">)</span>

            <span class="c1"># process the logfile, user can rename it</span>
            <span class="n">netlist_radic</span> <span class="o">=</span> <span class="n">run_netlist_file</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.net&#39;</span><span class="p">)</span>
            <span class="n">raw_file</span> <span class="o">=</span> <span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.raw&#39;</span>
            <span class="n">log_file</span> <span class="o">=</span> <span class="n">netlist_radic</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span>
            <span class="c1"># print simulation time</span>
            <span class="n">sim_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">clock_function</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
            <span class="c1"># handle simstate</span>
            <span class="k">if</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># simulation successful</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;: Simulation Successful. Time elapsed </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sim_time</span><span class="p">,</span> <span class="n">END_LINE_TERM</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">,</span> <span class="n">END_LINE_TERM</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">okSim</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># simulation failed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failSim</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># raise exception for try/except construct</span>
                <span class="c1"># SRC: https://stackoverflow.com/questions/2052390/manually-raising-throwing-an-exception-in-python</span>
                <span class="c1"># raise ValueError(time.asctime() + &#39;: Simulation number &#39; + str(self.runno) + &#39; Failed !&#39;)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;: Simulation Failed. Time elapsed </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sim_time</span><span class="p">,</span> <span class="n">END_LINE_TERM</span><span class="p">))</span>
                <span class="c1"># update failed parameters and counter</span>
                <span class="n">log_file</span> <span class="o">+=</span> <span class="s1">&#39;fail&#39;</span>

            <span class="k">if</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If simulation is successful</span>
                <span class="k">return</span> <span class="n">raw_file</span><span class="p">,</span> <span class="n">log_file</span>  <span class="c1"># Return rawfile and logfile if simulation was OK</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no simulation required</span>
            <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;skipping simulation &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runno</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># get script absolute path</span>
    <span class="n">meAbsPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">meAbsPath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">meAbsPath</span><span class="p">)</span>
    <span class="c1"># select spice model</span>
    <span class="n">LTC</span> <span class="o">=</span> <span class="n">LTCommander</span><span class="p">(</span><span class="n">meAbsPath</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">test_files</span><span class="se">\\</span><span class="s2">testfile.asc&quot;</span><span class="p">)</span>
    <span class="c1"># set default arguments</span>
    <span class="n">LTC</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">res</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">)</span>
    <span class="c1"># define simulation</span>
    <span class="n">LTC</span><span class="o">.</span><span class="n">add_instructions</span><span class="p">(</span>
        <span class="s2">&quot;; Simulation settings&quot;</span><span class="p">,</span>
        <span class="c1"># [&quot;.STEP PARAM Rmotor LIST 21 28&quot;],</span>
        <span class="s2">&quot;.TRAN 3m&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;.step param run 1 2 1&quot;</span>
    <span class="p">)</span>
    <span class="c1"># do parameter sweep</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># LTC.runs_to_do = range(2)</span>
        <span class="n">LTC</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">ANA</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
        <span class="n">raw</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LTC</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw file &#39;</span><span class="si">%s</span><span class="s2">&#39; | Log File &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">log</span><span class="p">))</span>
    <span class="c1"># Sim Statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successful/Total Simulations: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">LTC</span><span class="o">.</span><span class="n">okSim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">LTC</span><span class="o">.</span><span class="n">runno</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">callback_function</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Handling the simulation data of </span><span class="si">%s</span><span class="s2">, log file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">log_file</span><span class="p">))</span>

    <span class="n">LTC</span> <span class="o">=</span> <span class="n">SimCommander</span><span class="p">(</span><span class="n">meAbsPath</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">test_files</span><span class="se">\\</span><span class="s2">testfile.asc&quot;</span><span class="p">,</span> <span class="n">parallel_sims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tstop</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">tduration</span> <span class="o">=</span> <span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span>
        <span class="n">LTC</span><span class="o">.</span><span class="n">add_instruction</span><span class="p">(</span><span class="s2">&quot;.tran </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tduration</span><span class="p">),)</span>
        <span class="k">if</span> <span class="n">tstart</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LTC</span><span class="o">.</span><span class="n">add_instruction</span><span class="p">(</span><span class="s2">&quot;.loadbias </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bias_file</span><span class="p">))</span>
            <span class="c1"># Put here your parameter modifications</span>
            <span class="c1"># LTC.set_parameters(param1=1, param2=2, param3=3)</span>
        <span class="n">bias_file</span> <span class="o">=</span> <span class="s2">&quot;sim_loadbias_</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="n">tstop</span>
        <span class="n">LTC</span><span class="o">.</span><span class="n">add_instruction</span><span class="p">(</span><span class="s2">&quot;.savebias </span><span class="si">{}</span><span class="s2"> internal time=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bias_file</span><span class="p">,</span> <span class="n">tduration</span><span class="p">))</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">tstop</span>
        <span class="n">LTC</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">callback_function</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PyLTSpice</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../LTSpiceBatch.html">LTSpiceBatch.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SpiceEditor.html">SpiceEditor.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LTSpice_RawRead.html">LTSpice_RawRead.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LTSpice_RawWrite.html">LTSpice_RawWrite.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LTSteps.html">LTSteps.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Histogram.html">Histogram.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SemiOpLogReader.html">LTSpice_SemiDevOpReader.py</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Nuno Brum.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>